{% extends 'base.html.twig' %}

{% block title %}Détail du message{% endblock %}

{% block body %}
<div class="max-w-2xl mx-auto mt-12 p-8 bg-white rounded-2xl shadow-md border-2 border-primaryBlue">
    <h1 class="text-3xl font-bold text-primaryBlue mb-4">Message de {{ message.author.email }}</h1>

    <p class="text-gray-700 text-lg mb-4">
        {{ message.content }}
    </p>

    {% if message.image %}
        <img src="{{ asset(message.image) }}" alt="Image du message" class="rounded-xl shadow mb-4">
    {% endif %}

    <p class="text-sm text-gray-500">
        Publié le {{ message.createdAt|date('d/m/Y à H:i') }}
    </p>

    <hr class="my-6 border-gray-300">

    {# --- Flash messages --- #}
    {% for label, messages in app.flashes %}
        {% for flash in messages %}
            <div class="p-4 mb-4 rounded-xl text-white {% if label == 'success' %}bg-green-500{% else %}bg-red-500{% endif %}">
                {{ flash }}
            </div>
        {% endfor %}
    {% endfor %}

    {# --- Comment form --- #}
    <h2 class="text-2xl font-semibold text-primaryBlue mb-4">Laisser un commentaire</h2>

    <form method="post">
        <textarea name="comment" rows="2" placeholder="Écrivez votre commentaire ici..."
                  class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primaryBlue mb-4"></textarea>

        <button type="submit"
                class="py-2 px-4 bg-primaryBlue text-white font-bold rounded-xl shadow-md hover:bg-primaryGreen transition">
            Publier le commentaire
        </button>
    </form>

    {# --- Display comments --- #}
    <h2 class="text-2xl font-semibold text-primaryBlue mb-4 mt-8">Commentaires</h2>

    {% if message.comments|length > 0 %}
        <div class="space-y-4">
            {% for comment in message.comments %}
                <div class="border border-gray-300 rounded-xl p-4 bg-gray-50 relative">
                    <p class="text-gray-800">{{ comment.content }}</p>
                    <p class="text-sm text-gray-500">
                        Par {{ comment.author.email }} le {{ comment.createdAt|date('d/m/Y à H:i') }}
                    </p>

                    {# --- Edit/Delete buttons for comment author, OP, or admin --- #}
                    {% if is_granted('ROLE_ADMIN') 
                          or comment.author == app.user 
                          or comment.message.author == app.user %}
                        <div class="absolute top-2 right-2 space-x-2">
                            <a href="{{ path('comment_edit', {'id': comment.id}) }}" class="text-blue-500 hover:underline">Modifier</a>

                            <form action="{{ path('comment_delete', {'id': comment.id}) }}" method="post" class="inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?');">
                                <button type="submit" class="text-red-500 hover:underline bg-none border-none p-0">Supprimer</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 italic">Aucun commentaire pour l’instant.</p>
    {% endif %}

    {# --- Return link --- #}
    <a href="{{ path('default_home') }}"
       class="inline-block mt-6 py-2 px-4 bg-primaryBlue text-white font-bold rounded-xl shadow-md hover:bg-primaryGreen transition">
         Retour à la liste
    </a>

    {# --- Message-level Edit/Delete for admins or message author --- #}
    {% if is_granted('ROLE_ADMIN') or message.author == app.user %}
        <div class="mt-4">
            <a href="{{ path('message_update', {'id': message.id}) }}" class="inline-block mt-6 py-2 px-4 bg-primaryBlue text-white font-bold rounded-xl shadow-md hover:bg-primaryGreen transition">Modifier</a>
            <form action="{{ path('message_delete', {'id': message.id}) }}" method="post" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce message ?');">
                <button type="submit" class="inline-block mt-6 py-2 px-4 bg-primaryBlue text-white font-bold rounded-xl shadow-md hover:bg-primaryGreen transition">Supprimer</button>
            </form>
        </div>
    {% endif %}
</div>
{% endblock %}
