{% extends 'base.html.twig' %}

{% block title %}Détail du message{% endblock %}

{% block body %}
<div class="max-w-2xl mx-auto mt-12 p-8 bg-white dark:bg-darkBg rounded-2xl shadow-md border-2 border-primaryBlue dark:border-primaryGreen">

    <h1 class="text-3xl font-bold text-primaryBlue dark:text-primaryGreen mb-4">
        Message de {{ message.author.email }}
    </h1>

    <p class="text-gray-700 dark:text-gray-300 text-lg mb-4">
        {{ message.content }}
    </p>

    {% if message.image %}
        <img src="{{ asset(message.image) }}" alt="Image du message"
             class="rounded-xl shadow mb-4 border border-gray-200 dark:border-gray-700">
    {% endif %}

    <p class="text-sm text-gray-500 dark:text-gray-400">
        Publié le {{ message.createdAt|date('d/m/Y à H:i') }}
    </p>

    <hr class="my-6 border-gray-300 dark:border-gray-700">

    {# --- Flash messages --- #}
    {% for label, messages in app.flashes %}
        {% for flash in messages %}
            <div class="p-4 mb-4 rounded-xl text-white 
                        {% if label == 'success' %}bg-green-500{% else %}bg-red-500{% endif %}">
                {{ flash }}
            </div>
        {% endfor %}
    {% endfor %}

    <h2 class="text-2xl font-semibold text-primaryBlue dark:text-primaryGreen mb-4">
        Laisser un commentaire
    </h2>

    <form method="post" class="bg-white dark:bg-darkBg p-4 rounded-xl border border-gray-300 dark:border-gray-700">
        <textarea name="comment" rows="2" placeholder="Écrivez votre commentaire ici..."
                  class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-xl 
                         bg-white dark:bg-darkBg text-gray-800 dark:text-gray-200 
                         focus:outline-none focus:ring-2 focus:ring-primaryBlue dark:focus:ring-primaryGreen mb-4"></textarea>

        <button type="submit"
                class="py-2 px-4 bg-primaryBlue dark:bg-primaryGreen 
                       text-white font-bold rounded-xl shadow-md hover:opacity-90">
            Publier le commentaire
        </button>
    </form>

    <h2 class="text-2xl font-semibold text-primaryBlue dark:text-primaryGreen mb-4 mt-8">
        Commentaires
    </h2>

    {% if message.comment|length > 0 %}
        <div class="space-y-4">

            {% for comment in message.comment %}
                <div class="border border-gray-300 dark:border-gray-700 rounded-xl p-4 
                            bg-white dark:bg-gray-900 relative">
                    <p class="text-gray-800 dark:text-gray-200">{{ comment.content }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">

                        Par {{ comment.author.email }} le {{ comment.createdAt|date('d/m/Y à H:i') }}
                    </p>

                    {% if is_granted('ROLE_ADMIN') or comment.author == app.user %}
                        <div class="absolute top-2 right-2 space-x-2">
                            <a href="{{ path('comment_edit', {'id': comment.id}) }}"
                               class="text-blue-500 dark:text-primaryGreen hover:underline">Modifier</a>

                            <form action="{{ path('comment_delete', {'id': comment.id}) }}"
                                  method="post" class="inline"
                                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?');">
                                <button type="submit"
                                        class="text-red-500 dark:text-red-400 hover:underline bg-none border-none p-0">
                                    Supprimer
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 dark:text-gray-400 italic">Aucun commentaire pour l’instant.</p>
    {% endif %}

    <a href="{{ path('default_home') }}"
       class="inline-block mt-6 py-2 px-4 bg-primaryBlue dark:bg-primaryGreen 
              text-white font-bold rounded-xl shadow-md hover:opacity-90">
         Retour à la liste
    </a>

    {% if is_granted('ROLE_ADMIN') or message.author == app.user %}
        <div class="mt-4 space-x-2">
            <a href="{{ path('message_update', {'id': message.id}) }}"
               class="inline-block mt-6 py-2 px-4 bg-primaryBlue dark:bg-primaryGreen 
                      text-white font-bold rounded-xl shadow-md hover:opacity-90">
                Modifier
            </a>

            <form action="{{ path('message_delete', {'id': message.id}) }}"
                  method="post" class="inline"
                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce message ?');">
                <button type="submit"
                        class="inline-block mt-6 py-2 px-4 bg-primaryBlue dark:bg-primaryGreen 
                               text-white font-bold rounded-xl shadow-md hover:opacity-90">
                    Supprimer
                </button>
            </form>
        </div>
    {% endif %}
</div>
{% endblock %}